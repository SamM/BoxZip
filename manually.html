<html>

<head>
    <title>Binary Division Experiments</title>
    <script src="BoxZip.js" type="text/javascript"></script>
    <script src="tag.js" type="text/javascript"></script>
    <script type="text/javascript">
        

        let scene;
        let screen;
        let SIZE = 1980;
        // D = 24, S = 12
        // D = 24, S = 14
        // D = 26, S = 14
        // 26, 8
        // D = 24, S = (15) ** Above this is near the max before it starts getting really slow 
        // With random patterns on anyway
        // random_pat = 1; D = 14; S = 6
        let DEPTH = 24;
        let SQUARES = Math.pow(2,15);
        let REVERSE = 1;
        let random_patterns = false;
        let stop_animation = true;
        let JIGGLE = 0;
        let palettes = [];
        let pattern = 0;
        let BG = 'white';
        let MIN_DEPTH = 0;
        let LIGHT_MIX = [0,100];
        let LIGHT_BALANCE = 0;
        let ALPHA_MIX = [0,0.25];

        let SIZE_LIGHT_BIAS = 0.75;
        let SIZE_ALPHA_BIAS = 0;

        let FLIP_LIGHT_BIAS = 0;
        let FLIP_ALPHA_BIAS = 1;
        palettes.push( 'red/yellow/green'.split('/') );
        palettes.push( 'blue/orange/white'.split('/') );

        function Palette(Template, choice){
            function Picker(I){
                return Template[I%Template.length];
            }
            if(typeof choice == 'number') return Picker(choice);
            return Picker;
        }

        function Pattern(Template, length){
            function Unroll(L){
                if(typeof L !=='number') return [];
                if(L === 0) return [];
                
                let reverse = false;
                let index, pattern = [];

                if(L < 0){
                    L = -L;
                    reverse = true;
                }
                
                for(let i=0;i<L;i++){
                    index = i % Template.length;
                    pattern.push(Template[index]);
                }

                if(reverse) pattern = pattern.reverse();
                if(typeof Template == 'string') pattern = pattern.join('');
                
                return pattern;
            }
            if(typeof length == 'number') return Unroll(length);
            return Unroll;
        }

        function PatternBox(template, palette, N, offset){
            let pattern = Pattern(template);
            let colors = Palette(palette);
            let box = BoxZip();
            function BoxAt(index){
                let path = pattern(index);
                let color = colors(index);
                let address = Path.toIndex(path);
                box(address, color);
            }
            if(typeof offset !== 'number') offset = 0;
            if(typeof N !== 'number') N = template.length;
            for(let i=offset; i < N; i++){
                BoxAt(i);
            }
            return box;
        }

        function RandomInt(from, to){
            if(arguments.length == 1){
                to = from;
                from = 0;
            }
            if(typeof from != 'number') from = 0;
            if(typeof to != 'number') to = 1;
            return Math.floor(from + Math.floor(Math.random()*(to-from)));
        }
        function HSLAColor(H, S, L, A){
            function Color(){
                if(arguments.length == 0) return Color.toString();
            }
            Color.H = typeof H == 'number' ? H : 0;
            Color.S = typeof S == 'number' ? S : 0;
            Color.L = typeof L == 'number' ? L : 0;
            Color.A = typeof A == 'number' ? A : 0;
            Color.toString = function(){
                let alpha = (Color.A+'');
                if(alpha.indexOf('.')>-1) alpha = alpha.slice(0, alpha.indexOf('.')+2);
                return 'hsla('+[Math.round(Color.H), Math.round(Color.S)+'%', Math.round(Color.L)+'%', alpha].join(',')+')'
            }
            return Color;
        }
        function RandomColor(alpha, light){
            if(typeof alpha != 'number') alpha = 1;
            if(alpha > 1) alpha = 1;
            if(alpha < 0) alpha = 0;
            
            let L;
            if(typeof light == 'number') L = light;
            else L = Math.min(100, Math.max(0, LIGHT_BALANCE + RandomInt(LIGHT_MIX[0],LIGHT_MIX[1])));
            return HSLAColor(RandomInt(360), RandomInt(15,90), L, alpha);
        }

        function RandomPalette(N){
            if(typeof N != 'number') N = RandomInt(3,8);
            if(N<0) N = -N;
            var palette = [];
            for(let i=0;i<N;i++){
                palette.push(RandomColor(ALPHA_MIX[0] + ((ALPHA_MIX[1]-ALPHA_MIX[0]) * Math.random())));
            }
            //console.log('random palette')
            return Palette(palette);
        }

        function RandomBox(n, max_depth, bg_color){
            if(typeof bg_color == 'undefined') bg_color = HSLAColor(0,0,50,0);
            if(typeof max_depth != 'number') max_depth = 5;
            if(max_depth < 0) max_depth = 2;
            let box = BoxZip(bg_color);
            let x;
            for(var i=0; i<n; i++){
                x = Math.pow(2,RandomInt(max_depth/2,max_depth));
                x = (Math.random() * x);
                box(Math.round(x), RandomColor(Math.random()+0.5))
            }
            return box;
        }
        
        let ctx;

        function drawSquare(color, o){
            //console.log('Drawing Square', o)
            if(MIN_DEPTH && o.i == '' || o.i < Math.pow(2, MIN_DEPTH)) return;
            if(typeof color.L != 'undefined' && SIZE_LIGHT_BIAS || SIZE_ALPHA_BIAS){
                let S = Math.max(o.h, o.w);
                let L = Math.min(100, ( (100 * Math.min(1, 1-S))));
                L = Math.max(0, Math.min(100, L));
                let light_bias = FLIP_LIGHT_BIAS ? 100-L : L;
                let alpha_bias = FLIP_ALPHA_BIAS ? 100-L : 100-L;
                if(SIZE_LIGHT_BIAS) color.L = (color.L * (1-SIZE_LIGHT_BIAS)) + (light_bias * SIZE_LIGHT_BIAS);
                if(SIZE_ALPHA_BIAS) color.A = (color.A * (1-SIZE_LIGHT_BIAS)) + (alpha_bias * SIZE_ALPHA_BIAS);
            }
            //console.log(color);
            ctx.fillStyle = color+'' || 'none';
            let s = SIZE;
            let j = 0;
            if(JIGGLE){
                j = Math.random() * 2 * JIGGLE;
                j = Math.round(j);
            }
            function R(x){
                return Math.random()>0.5?j:-j;
            }
            ctx.fillRect((s*o.x)+R(), (s*o.y)+R(), (s*o.w)+R(), (s*o.h)+R());
        }

        function DrawScene(){
            //console.log('Drawing Scene');
            scene.draw(drawSquare, !!REVERSE);
        }

        function RandomPattern(N){
            if(typeof N != 'number') N = 10;
            let actions = [];
            let path = [];
            let r;
            for(let i=0;i<N;i++){
                r = Math.random()>0.5?1:0;
                path.push(r);
                actions.push([Path.toIndex(path), Math.random()>0.5?1:0]);
            }
            function DrawPattern(box, palette){
                if(typeof palette != 'function') palette = RandomPalette();
                //console.log('drawing pattern', N)
                for(let i=0;i<N;i++){
                    if(actions[i][1]) box(actions[i][0], palette(i));
                }
            }
            //console.log('returning random pattern')
            return DrawPattern;
        }

        function UpdateScene(){
            //console.log('Updatinging Scene');
            if(random_patterns){
                scene = BoxZip();
                //console.log('adding '+SQUARES+' amounts of squares', DEPTH)
                for(var i=0;i<SQUARES;i++){
                    RandomPattern(DEPTH)(scene);
                }
                return;
            }
            if(pattern){
                //console.log('Random Patterns');
                let p = pattern;
                if(!pattern) p = RandomInt(128);
                scene = PatternBox(Path.fromIndex(p), palettes[RandomInt(palettes.length)], DEPTH);
                return;
            }
            //console.log('Random Boxes');
            scene = RandomBox(SQUARES, DEPTH);
        }
        function ClearScreen(){
            //console.log('Clearing Scene');
            if(typeof BG == 'string'){
                ctx.fillStyle = BG;
                ctx.fillRect(0,0,SIZE,SIZE);
            }else{
                ctx.clearRect(0,0,SIZE,SIZE);
            }
        }

        function ToggleAnimation(){
            //console.log('Starting / Stopping animation');
            if(stop_animation){
                stop_animation = false;
                animate();
            }else{
                stop_animation = true;
            }
        }

        function ChangeSlide(){
            UpdateScene();
            ClearScreen();
            DrawScene();
        }

        function setup() {
            tag(document.body)('id', 'Sam').style('backgroundColor', 'black');
            screen = tag('canvas').create()('width', SIZE)('height', SIZE)('id', 'square').into(document.body);
            document.body.addEventListener('click', ChangeSlide);
            document.body.addEventListener('dblclick', ToggleAnimation);
            ctx = screen.DOM.getContext('2d');
            scene = BoxZip();
            
            UpdateScene();
            ClearScreen();
            // console.log('EEEEEEEEEEEE', scene.length)
            DrawScene();

            if(!stop_animation) ToggleAnimation();
        }
        
        function animate(){
            if(stop_animation) return;
            ////ChangeSlide();
            ClearScreen();
            DrawScene();
            window.requestAnimationFrame(animate);
        }

        window.addEventListener('load', setup);
    
    </script>
</head>

<body></body>

</html>